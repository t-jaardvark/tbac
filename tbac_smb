#!/bin/bash

BACKUP_FILE="/1/tjh/backups/arch-ghost/bac.d/bac_smb"

backup_cifs_mounts() {
    grep -E "cifs.*nofail" /etc/fstab > "$BACKUP_FILE"
    echo "CIFS mounts with 'nofail' option backed up to $BACKUP_FILE"
}

restore_cifs_mounts() {
    if [ ! -f "$BACKUP_FILE" ]; then
        echo "Backup file not found: $BACKUP_FILE"
        exit 1
    fi

    # Check and install dependencies
    if [ -f /etc/arch-release ]; then
        sudo pacman -S --needed cifs-utils
    elif [ -f /etc/debian_version ]; then
        sudo apt-get update
        sudo apt-get install -y cifs-utils
    elif [ -f /etc/fedora-release ]; then
        sudo dnf install -y cifs-utils
    else
        echo "Unsupported distribution. Please install CIFS utilities manually."
        exit 1
    fi

    # Append backed up mounts to /etc/fstab
    cat "$BACKUP_FILE" >> /etc/fstab
    echo "CIFS mounts restored to /etc/fstab"
}

case "$1" in
    backup)
        backup_cifs_mounts
        ;;
    restore)
        restore_cifs_mounts
        ;;
    *)
        echo "Usage: $0 {backup|restore}"
        exit 1
        ;;
esac
